import Elysia, { t } from 'elysia';
import { authMiddleware } from '../middlewares/auth';
import { database } from '../middlewares/db';
import { _createMessage } from '../libs/validation/chat';
import {
  createChat,
  createMessage,
  getChat,
  getMessages,
} from '../controllers/chat/chat-service';

export function chatRouter() {
  return new Elysia({ prefix: '/chats' })
    .use(authMiddleware)
    .use(database)
    .get(
      '/',
      async ({ user }) => {
        return await getChat(user);
      },
      {
        auth: true,
      },
    )
    /**
     * This end point create chat with the users specified by the user including himself
     */
    .post(
      '/',
      async ({ user, body: { userIds, chatId } }) => {
        return await createChat(user, userIds, chatId);
      },
      {
        auth: true,
        body: t.Object({
          userIds: t.Array(t.String({ error: 'You need to add some people' })),
          chatId: t.String({ format: 'uuid' }),
        }),
      },
    )
    .post(
      '/:chatId/message',
      async ({ body, params: { chatId }, user }) => {
        return createMessage(user, chatId, body);
      },
      { auth: true, body: t.Omit(_createMessage, ['chatId', 'userId']) },
    )
    .get(
      '/:chatId/messages',
      async (
        { user, params: { chatId }, query: { cursor, offset } },
      ) => {
        return await getMessages(user, chatId, cursor, offset);
      },
      {
        auth: true,
        query: t.Object({
          cursor: t.Number({ default: 0 }),
          offset: t.Number({ default: 0 }),
        }),
      },
    );
}
